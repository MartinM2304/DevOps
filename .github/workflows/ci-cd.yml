name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  IMAGE_NAME: requirements-app
  PHP_VERSION: "8.1"

jobs:
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2

      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress

      - name: Check Code Quality
        run: vendor/bin/phpcs --standard=PSR12 src/ || true

      - name: Run Unit Tests
        run: php vendor/bin/phpunit --testsuite Unit

      - name: sonarqube
        uses: sonarsource/sonarqube-scan-action@v6
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: "https://sonarcloud.io"
        with:
          args: >
            -Dsonar.organization=martinm2304
            -Dsonar.projectKey=martinm2304_DevOps

  build-push:
    needs: [quality-check]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build Docker Image
        run: docker build -f docker/Dockerfile -t ${{ env.IMAGE_NAME }}:latest .

      - name: Export Image Artifact
        run: docker save -o ${{ env.IMAGE_NAME }}.tar ${{ env.IMAGE_NAME }}:latest

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: ${{ env.IMAGE_NAME }}.tar
          retention-days: 1

      - name: Push to DockerHub
        if: github.ref == 'refs/heads/main'
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
          REMOTE_TAG=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}
          docker tag ${{ env.IMAGE_NAME }}:latest $REMOTE_TAG:latest
          docker push $REMOTE_TAG:latest

  integration-tests:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: requirements_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo, pdo_mysql
          tools: composer:v2

      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run Tests
        env:
          DB_HOST: 127.0.0.1
          DB_NAME: requirements_db
          DB_USER: root
          DB_PASS: root
        run: |
          php database/migrate.php
          php vendor/bin/phpunit --testsuite Integration

  deploy-to-k3d:
    needs: [build-push, integration-tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install k3d
        run: curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Create Cluster
        run: k3d cluster create my-cluster --port 8000:80@loadbalancer --k3s-arg "--disable=traefik@server:*"

      - name: Load Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Import to K3d
        run: |
          docker load -i ${{ env.IMAGE_NAME }}.tar
          k3d image import ${{ env.IMAGE_NAME }}:latest -c my-cluster

      - name: Deploy
        run: |
          kubectl apply -f k8s/db-deployment.yaml
          kubectl wait --for=condition=ready pod -l app=db --timeout=120s
          
          kubectl apply -f k8s/app-deployment.yaml
          
          if ! kubectl rollout status deployment/requirements-app --timeout=120s; then
            echo "::error::Deployment Crashed! Dumping logs..."
            kubectl logs -l app=requirements-app --all-containers=true --tail=100
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: k3d cluster delete my-cluster